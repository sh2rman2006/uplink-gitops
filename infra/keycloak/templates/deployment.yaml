apiVersion: apps/v1
kind: Deployment
metadata:
  name: uplink-keycloak
  namespace: {{ .Values.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "3"
  labels:
    app: uplink-keycloak
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      app: uplink-keycloak
  template:
    metadata:
      labels:
        app: uplink-keycloak
    spec:
      {{- if .Values.spi.enabled }}
      initContainers:
        - name: keycloak-kafka-listener-init
          image: "{{ .Values.spi.image.repository }}:{{ .Values.spi.image.tag }}"
          imagePullPolicy: {{ .Values.spi.image.pullPolicy }}
          command: [ "sh","-c" ]
          args:
            - |
              set -e
              cp {{ .Values.spi.jarPath | quote }} "/providers/{{ .Values.spi.jarName }}"
              ls -lah /providers
          volumeMounts:
            - name: providers
              mountPath: /providers
      {{- end }}

      containers:
        - name: keycloak
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}

          args:
            - "start"
            {{- range .Values.keycloak.extraArgs }}
            - {{ . | quote }}
            {{- end }}

          env:
            - name: KC_BOOTSTRAP_ADMIN_USERNAME
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.secrets.admin.targetSecretName | quote }}
                  key: adminUser
            - name: KC_BOOTSTRAP_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.secrets.admin.targetSecretName | quote }}
                  key: adminPassword

            - name: KC_DB
              value: "postgres"

            - name: KC_DB_URL_HOST
              value: {{ .Values.postgres.host | quote }}
            - name: KC_DB_URL_PORT
              value: {{ .Values.postgres.port | quote }}

            - name: KC_DB_URL_DATABASE
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.secrets.db.targetSecretName | quote }}
                  key: database
            - name: KC_DB_USERNAME
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.secrets.db.targetSecretName | quote }}
                  key: username
            - name: KC_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.secrets.db.targetSecretName | quote }}
                  key: password

            - name: KC_HTTP_ENABLED
              value: "true"
            - name: KC_PROXY
              value: "edge"
            - name: KC_HOSTNAME
              value: {{ .Values.ingress.host | quote }}
            - name: KC_HOSTNAME_STRICT
              value: "true"
            - name: KC_HEALTH_ENABLED
              value: "true"
            - name: KC_METRICS_ENABLED
              value: "true"

            - name: KC_EVENTS_ENABLED
              value: "true"
            - name: KC_EVENTS_ADMIN_ENABLED
              value: "true"
            - name: KC_EVENTS_LISTENERS
              value: "kafka"

            - name: KAFKA_BOOTSTRAP_SERVERS
              value: {{ .Values.kafka.bootstrapServers | quote }}
            - name: KAFKA_TOPIC_USER
              value: {{ .Values.kafka.topicUser | quote }}
            - name: KAFKA_TOPIC_ADMIN
              value: {{ .Values.kafka.topicAdmin | quote }}
            - name: KAFKA_ENABLED_EVENTS
              value: {{ .Values.kafka.enabledEvents | quote }}

          ports:
            - name: http
              containerPort: 8080

          readinessProbe:
            httpGet:
              path: /health/ready
              port: http
            initialDelaySeconds: 20
            periodSeconds: 10

          livenessProbe:
            httpGet:
              path: /health/live
              port: http
            initialDelaySeconds: 40
            periodSeconds: 20

          resources:
{{ toYaml .Values.resources | indent 12 }}

          {{- if .Values.spi.enabled }}
          volumeMounts:
            - name: providers
              mountPath: /opt/keycloak/providers
          {{- end }}

      {{- if .Values.spi.enabled }}
      volumes:
        - name: providers
          emptyDir: { }
      {{- end }}
